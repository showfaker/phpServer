
<link rel="shortcut icon" href="favicon.ico"> <link href="css/bootstrap.min.css?v=3.3.6" rel="stylesheet">
<link href="css/font-awesome.css?v=4.4.0" rel="stylesheet">
<link href="css/plugins/iCheck/custom.css" rel="stylesheet">
<link href="css/animate.css" rel="stylesheet">
<link href="css/style.css?v=4.1.0" rel="stylesheet">
<link rel="stylesheet" href="css/main.css">

<div class="modal-header">
	<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">关闭</span>
	</button>
	<h4 class="modal-title">设置计划</h4>
</div>
<form method="post" id="sgjhform" action="__APP__/Sgjh/insert/callbackType/closeCurrent/navTabId/Second" ENCTYPE="multipart/form-data" onsubmit="return false;">
<div class="modal-body" id="file-pretty"> 
	<input type="hidden" value="{$orgdata.id}" name="id">
	<input type="hidden" value="{$change}" name="change">
	<input type="hidden" value="{$moduletitle}" name="moduletitle">
	<div class="form-group">
		<label style="float:left">项目名称</label>
		<input type="text" placeholder="" class="form-control" readonly value="{$orgdata['title']}">
	</div>
	<table class="drafttable" style="position:relative;top:8px;margin:0 auto;width:100%;margin-bottom:28px;font-family:微软雅黑">
		<tr>
			<td class="normal" style="font-weight:bold;height:45px;background-color:#F5F5F6">专项</td>
			<in name="moduletitle" value="设备到货计划">
			<td class="normal" style="font-weight:bold;height:45px;background-color:#F5F5F6;">供货周期</td>
			</in>
			<in name="moduletitle" value="采购专项计划,设备到货计划">
			<td class="normal" style="font-weight:bold;height:45px;background-color:#F5F5F6;">批次</td>
			<td class="normal" style="font-weight:bold;height:45px;background-color:#F5F5F6;">计划数量</td>
			</in>
			
			<td class="normal" style="font-weight:bold;height:45px;background-color:#F5F5F6">节点</td>
			<td class="normal" style="font-weight:bold;height:45px;background-color:#F5F5F6">计划开始时间</td>
			<td class="normal" style="font-weight:bold;height:45px;background-color:#F5F5F6">计划完成时间</td>
			<notin name="moduletitle" value="采购专项计划,设备到货计划">
			<td class="normal" style="font-weight:bold;height:45px;background-color:#F5F5F6">工程量</td>
			</notin>
		</tr>
		
		
		<notin name="moduletitle" value="设备到货计划">
		<volist name="orgdata.worktype" id="worktype">
		<input type="hidden" name="classify[]" value="{$worktype.classify}">
		<input type="hidden" name="attribute[]" value="{$worktype.attribute}">
		<input type="hidden" name="qualityunit[]" value="{$worktype.qualityunit}">
		<input type="hidden" name="pworktype[]" value="{$worktype.pworktype}">
		<input type="hidden" name="worktype[]" value="{$worktype.title}">
		<tr>
			<eq name="worktype.block" value="1">
			<td class="normal" rowspan="{$worktype.rowspan}" style="font-weight:bold;height:45px">{$worktype.pworktype}</td>
			
			<in name="moduletitle" value="设备到货计划">
			<td class="normal" rowspan="{$worktype.rowspan}" style="font-weight:bold;height:45px">
			{$worktype.period}天
			</td>
			</in>
			</eq>
			
			<in name="moduletitle" value="采购专项计划,设备到货计划">
			<in name="key" value="0,4,8,12,16,20,24,28,32,36,40,44,48,52,56,60,64,68,72,76">
			<td class="normal" rowspan="4" >
			<input value="{$orgdata[worktype][$key][schedule][branch]}" type="hidden" name="branch[]" title="占位">
			<input value="{$orgdata[worktype][$key+1][schedule][branch]}" type="hidden" name="branch[]" title="占位">
			<input value="{$orgdata[worktype][$key+2][schedule][branch]}" type="hidden" name="branch[]" title="占位">
			<input value="{$orgdata[worktype][$key+3][schedule][branch]}" class="form-control" type="text" name="branch[]" readonly <eq name="_SESSION[app]" value="1">style="width:40px;font-size:10px;"</eq> style="width:100px;font-size:14px">
			</td>
			</in>
			</in>
			
			<in name="moduletitle" value="采购专项计划,设备到货计划">
			<in name="key" value="0,4,8,12,16,20,24,28,32,36,40,44,48,52,56,60,64,68,72,76">
			<td class="normal" rowspan="4">
			
			<neq name="orgdata[worktype][$key+3][schedule][plancountold]" value="">
			<neq name="orgdata[worktype][$key+3][schedule][plancountold]" value="$orgdata[worktype][$key+3][schedule][plancount]">
			<font style="color:orange">原{$orgdata[worktype][$key+3][schedule][plancountold]}</font>
			</neq>
			</neq>
			
			<input value="{$orgdata[worktype][$key][schedule][plancount]}" type="hidden" name="plancount[]" title="占位">
			<input value="{$orgdata[worktype][$key+1][schedule][plancount]}" type="hidden" name="plancount[]" title="占位">
			<input value="{$orgdata[worktype][$key+2][schedule][plancount]}" type="hidden" name="plancount[]" title="占位">
			<input value="{$orgdata[worktype][$key+3][schedule][plancount]}" class="form-control" type="text" name="plancount[]" readonly <eq name="_SESSION[app]" value="1">style="width:40px;font-size:10px;"</eq> style="width:50px;font-size:14px">
			</td>
			</in>
			</in>
			
			
			<td class="normal" >
			<neq name="worktype.attribute">（{$worktype.attribute}）</neq>{$worktype.title}
			</td>
			
			
			<td class="normal" >
			
			<in name="moduletitle" value="采购专项计划">
			<eq name="worktype.title" value="到货情况">
			<neq name="orgdata[worktype][$key][schedule][plantimebeginold]" value="">
			<neq name="orgdata[worktype][$key][schedule][plantimebeginold]" value="$orgdata[worktype][$key][schedule][plantimebegin]">
			<font style="color:orange">原{$orgdata[worktype][$key][schedule][plantimebeginold]}</font>
			</neq>
			</neq>
			</eq>
			</in>
			
			<input value="{$worktype[schedule][plantimebegin]}" type="text" name="plantimebegin[]" placeholder="" class="required" 
			<neq name="worktype.title" value="到货情况">style="position:relative;border:0px;border-bottom:1px solid #BBBBBB;height:25px;background:white;width:80px" onclick="takeplantimebegin({$worktype.id},{$key})"</neq>
			<eq name="worktype.title" value="到货情况">style="position:relative;border:0px;border-bottom:1px solid #eee;height:25px;background:#eee;width:80px" readonly onclick="takeplantimebegin({$worktype.id},{$key})"</eq>>
			</td>
			<td class="normal" >
			
			<in name="moduletitle" value="采购专项计划">
			<eq name="worktype.title" value="到货情况">
			<neq name="orgdata[worktype][$key][schedule][plantimeendold]" value="">
			<neq name="orgdata[worktype][$key][schedule][plantimeendold]" value="$orgdata[worktype][$key][schedule][plantimeend]">
			<font style="color:orange">原{$orgdata[worktype][$key][schedule][plantimeendold]}</font>
			</neq>
			</neq>
			</eq>
			</in>
			
			<input value="{$worktype[schedule][plantimeend]}" type="text" name="plantimeend[]" placeholder="" class="required"
			<neq name="worktype.title" value="到货情况">style="position:relative;border:0px;border-bottom:1px solid #BBBBBB;height:25px;background:white;width:80px" onclick="laydate({istime: false, format: 'YYYY-MM-DD'})"</neq>
			<eq name="worktype.title" value="到货情况">style="position:relative;border:0px;border-bottom:1px solid #eee;height:25px;background:#eee;width:80px" readonly onclick="laydate({istime: false, format: 'YYYY-MM-DD'})"</eq>>
			</td>
			
			<notin name="moduletitle" value="采购专项计划,设备到货计划">
			<td class="normal" >
			<input value="{$worktype[schedule][planquality]}" <eq name="worktype.qualityunit" value="">type="hidden"</eq>  <neq name="worktype.qualityunit" value="">type="text"</neq> style="position:relative;border:0px;border-bottom:1px solid #BBBBBB;height:25px;background:white;width:30px" name="planquality[]" placeholder="">{$worktype[qualityunit]}
			</td>
			</notin>
		</tr>
		</volist>
		</notin>
		
		
		<in name="moduletitle" value="设备到货计划">
		<volist name="orgdata.worktype" id="worktype">
		<input type="hidden" name="classify[]" value="{$worktype.classify}">
		<input type="hidden" name="attribute[]" value="{$worktype.attribute}">
		<input type="hidden" name="qualityunit[]" value="{$worktype.qualityunit}">
		<input type="hidden" name="pworktype[]" value="{$worktype.pworktype}">
		<input type="hidden" name="worktype[]" value="{$worktype.title}">
		<tr <neq name="worktype.title" value="到货情况">style="display:none"</neq>>
			
			<td class="normal" style="font-weight:bold;height:45px">{$worktype.pworktype}</td>
			<td class="normal" style="font-weight:bold;height:45px">{$worktype.period}天</td>
			<td class="normal">
			<input value="{$orgdata[worktype][$key][schedule][plancount]}" class="form-control" type="text" name="plancount[]" <eq name="_SESSION[app]" value="1">style="width:40px;font-size:10px;"</eq> style="width:70px;font-size:14px">
			</td>
			<td class="normal" >
			<neq name="worktype.attribute">（{$worktype.attribute}）</neq>{$worktype.title}
			</td>
			<td class="normal" >
			<input value="{$worktype[schedule][plantimebegin]}" type="text" style="position:relative;border:0px;border-bottom:1px solid #BBBBBB;height:25px;background:white;width:80px" name="plantimebegin[]"
			onclick="takeplantimebegin({$worktype.id},{$key})" placeholder="" class="required">
			</td>
			<td class="normal" >
			<input value="{$worktype[schedule][plantimeend]}" type="text" style="position:relative;border:0px;border-bottom:1px solid #BBBBBB;height:25px;background:white;width:80px" name="plantimeend[]"
			onclick="laydate({istime: false, format: 'YYYY-MM-DD'})" placeholder="" class="required">
			</td>
		</tr>
		</volist>
		</in>
	</table>
	
	<div class="form-group" style="display:none">
		<label style="float:left">运营验收计划时间</label>
		<input type="text" placeholder="填写运营验收计划时间" class="form-control" name="predate100" <neq name="flag" value="0">onclick="laydate({istime: false, format: 'YYYY-MM-DD'})"</neq> value="{$orgdata['predate100']}" <eq name="flag" value="0">readonly</eq>>
	</div>
	<div class="form-group" style="display:none">
		<label style="float:left">项目验收计划时间</label>
		<input type="text" placeholder="填写项目验收计划时间" class="form-control" name="predate101" <neq name="flag" value="0">onclick="laydate({istime: false, format: 'YYYY-MM-DD'})"</neq> value="{$orgdata['predate101']}" <eq name="flag" value="0">readonly</eq>>
	</div>
	<div class="form-group" style="display:none">
		<label style="float:left">项目投运计划时间</label>
		<input type="text" placeholder="填写项目投运计划时间" class="form-control" name="predate102" <neq name="flag" value="0">onclick="laydate({istime: false, format: 'YYYY-MM-DD'})"</neq>value="{$orgdata['predate102']}" <eq name="flag" value="0">readonly</eq>>
	</div>
	
	
	<eq name="change" value="1">
	<div class="form-group">
		<label style="float:left">变更原因</label>
		<input type="text" placeholder="填写变更原因" class="form-control" name="reason" value="">
	</div>
	</eq>
	
	<eq name="flag" value="0">
	<div class="form-group" <in name="moduletitle" value="采购专项计划,设备到货计划">style="display:none"</in>>
		<label style="float:left;color:red;font-weight:bold">施工计划初始化：请填写开工日期，由系统自动生成计划时间</label>
		<input type="text" placeholder="请填写开工日期，由系统自动生成计划时间" class="form-control" name="start" value="" id="start" onclick="takeit();" onchange="takeit1(this.value)">
		<a href="javascript:void(0)" onclick="takeit0()" class="btn btn-info btn-xs" style="margin-left:0px;float:right">根据当前时间自动生成</a>
	</div>
	</eq>
	
	
	
	
	
	<script>
	var id="<?php echo $orgdata["id"];?>";
	//var initdate="<?php echo date("Y-m-d",strtotime($orgdata["predate9x"])+24*60*60);?>";
	var initdate="<?php echo date("Y-m-d");?>";
	var moduletitle="<?php echo $moduletitle;?>";
	function takeit0()
	{
		document.getElementById("start").value=initdate;
		var aj = $.ajax({
			url:'__APP__/Sgjh/add_auto',
			data:{
				id:id,
				moduletitle:moduletitle,
				date:initdate
			},
			type:'post',  
			cache:false,  
			dataType:'json',
			success:function(data) {
				console.log(data.schedules);
				for(var i=0;i<data["schedules"].length;i++){
					$("input[name='plantimebegin[]']:eq("+i+")").val(data["schedules"][i]['timebegin']);
					$("input[name='plantimeend[]']:eq("+i+")").val(data["schedules"][i]['timeend']);
				}
				
				$("input[name='predate100']").val(data["predate"][100]);
				$("input[name='predate101']").val(data["predate"][101]);
				$("input[name='predate102']").val(data["predate"][102]);
			}  
		});
	}
	function takeit()
	{
		laydate({
			istime: false,
			istoday: false,
			format: 'YYYY-MM-DD',
			choose: function(value, date)
			{
				//alert('你选择的日期是：' + value + '\n获得的对象是' + JSON.stringify(date));
				
				var aj = $.ajax({
					url:'__APP__/Sgjh/add_auto',
					data:{
						id:id,
						moduletitle:moduletitle,
						date:value
					},
					type:'post',  
					cache:false,  
					dataType:'json',
					success:function(data) {
						console.log(data.schedules);
						for(var i=0;i<data["schedules"].length;i++){
							$("input[name='plantimebegin[]']:eq("+i+")").val(data["schedules"][i]['timebegin']);
							$("input[name='plantimeend[]']:eq("+i+")").val(data["schedules"][i]['timeend']);
						}
						
						$("input[name='predate100']").val(data["predate"][100]);
						$("input[name='predate101']").val(data["predate"][101]);
						$("input[name='predate102']").val(data["predate"][102]);
					}  
				});
			
			}
		});
	}
	function takeit1(value)
	{
		var aj = $.ajax({
			url:'__APP__/Sgjh/add_auto',
			data:{
				id:id,
				moduletitle:moduletitle,
				date:value
			},
			type:'post',  
			cache:false,  
			dataType:'json',
			success:function(data) {
				console.log(data.schedules);
				for(var i=0;i<data["schedules"].length;i++){
					$("input[name='plantimebegin[]']:eq("+i+")").val(data["schedules"][i]['timebegin']);
					$("input[name='plantimeend[]']:eq("+i+")").val(data["schedules"][i]['timeend']);
				}
				
				$("input[name='predate100']").val(data["predate"][100]);
				$("input[name='predate101']").val(data["predate"][101]);
				$("input[name='predate102']").val(data["predate"][102]);
			}  
		});
	}
	
	function takeplantimebegin(worktypeid,key)
	{
		laydate({
			istime: false,
			istoday: false,
			format: 'YYYY-MM-DD',
			choose: function(value, date)
			{
				//alert('你选择的日期是：' + value + '\n获得的对象是' + JSON.stringify(date));
				var aj = $.ajax({
					url:'__APP__/Sgjh/gettimeend',
					data:{
						id:id,
						worktypeid:worktypeid,
						moduletitle:moduletitle,
						date:value
					},
					type:'post',  
					cache:false,  
					dataType:'json',
					success:function(data) {
						console.log(data);
						$("input[name='plantimeend[]']:eq("+key+")").val(data);
					}  
				});
			
			}
		});
	}
	</script>
	
</div>
<input type="hidden" name="sgjhissave" id="sgjhissave" value="0">
<div class="modal-footer">
	<button type="submit" class="btn btn-warning" id="savesubmit">保存</button>
	<button type="submit" class="btn btn-danger" id="submit">提交</button>
	<button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
</div>
</form>



<script type="text/javascript" src="__PUBLIC__/js/jquery-form.js" ></script>
<script>
	document.getElementById("submit").addEventListener("click",function(){
		document.getElementById("sgjhissave").value=0;
		$('#sgjhform').ajaxSubmit({
			dataType:'json',//服务器返回json格式数据
            type: "post",
            url: "__APP__/Sgjh/insert/",
            data: $('#sgjhform').serialize(),
            error: function (data) {
				console.log(data);
				alert('服务器连接超时，请稍后再试');  
            },
            success: function (data) {
				var result = new Array();  
				result = eval(data);
				if(result['message']=="操作成功!")
				{
					alert("操作成功");
					location.href=location.href;
				}else{
					alert(result['message']);
				}
            }
        });
	});
	
	document.getElementById("savesubmit").addEventListener("click",function(){
		document.getElementById("sgjhissave").value=1;
		$('#sgjhform').ajaxSubmit({
			dataType:'json',//服务器返回json格式数据
            type: "post",
            url: "__APP__/Sgjh/insert/",
            data: $('#sgjhform').serialize(),
            error: function (data) {
				console.log(data);
				alert('服务器连接超时，请稍后再试');  
            },
            success: function (data) {
				var result = new Array();  
				result = eval(data);
				if(result['message']=="操作成功!")
				{
					alert("操作成功");
					location.href=location.href;
				}else{
					alert(result['message']);
				}
            }
        });
	});
</script>