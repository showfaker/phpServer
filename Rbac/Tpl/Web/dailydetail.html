<!DOCTYPE html>
<html>
 <head> 
  <meta charset="utf-8" /> 
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" /> 
  <title>施工日志详情</title> 
  <link href="__PUBLIC__/appsource/css/mui.css" rel="stylesheet" /> 
  <script type="text/javascript" src="__PUBLIC__/appsource/js/common.js"></script>
  <link href="__PUBLIC__/appsource/css/mui.picker.css" rel="stylesheet" />
  <link href="__PUBLIC__/appsource/css/mui.poppicker.css" rel="stylesheet" />
  <link rel="stylesheet" type="text/css" href="__PUBLIC__/appsource/css/mui.picker.min.css" />
  <style type="text/css">
            body {
                background-color: #efeff4;
            }
            .mui-content {} .mui-content a {
                color: #8F8F94;
            }
            .mui-content a.active {
                color: #007aff;
            }
            .mui-title {
                font-family: simhei;
            }
            .btn_1 {
                position: absolute;
                bottom: 100px;
                left: 10px;
                right: 10px;
            }
            .btn_2 {
                position: absolute;
                bottom: 20px;
                left: 10px;
                right: 10px;
            }
            .mui-btn-block {
                width: 90%;
                margin: 0 auto;
            }
            body {
                overflow: hidden;
            }
            .showimg {
                margin: 10px 10px auto 10px;
                float:left;
            }
            .add-tp{
                width: 46px;
                height: 46px;
                padding:2px;
                border:1px solid #ccc;
                border-radius:3px;
                float:left;
                margin-right:5px;
            }
            .add-tp img {
                width: 40px;
                height: 40px;
                float:left;
                border-radius:3px;
            }
        </style> 
        <!--App自定义的css-->
		<style type="text/css">
			.mui-preview-image.mui-fullscreen {
				position: fixed;
				z-index: 20;
				background-color: #000;
			}
			.mui-preview-header,
			.mui-preview-footer {
				position: absolute;
				width: 100%;
				left: 0;
				z-index: 10;
			}
			.mui-preview-header {
				height: 44px;
				top: 0;
			}
			.mui-preview-footer {
				height: 50px;
				bottom: 0px;
			}
			.mui-preview-header .mui-preview-indicator {
				display: block;
				line-height: 25px;
				color: #fff;
				text-align: center;
				margin: 15px auto 4;
				width: 70px;
				background-color: rgba(0, 0, 0, 0.4);
				border-radius: 12px;
				font-size: 16px;
			}
			.mui-preview-image {
				display: none;
				-webkit-animation-duration: 0.5s;
				animation-duration: 0.5s;
				-webkit-animation-fill-mode: both;
				animation-fill-mode: both;
			}
			.mui-preview-image.mui-preview-in {
				-webkit-animation-name: fadeIn;
				animation-name: fadeIn;
			}
			.mui-preview-image.mui-preview-out {
				background: none;
				-webkit-animation-name: fadeOut;
				animation-name: fadeOut;
			}
			.mui-preview-image.mui-preview-out .mui-preview-header,
			.mui-preview-image.mui-preview-out .mui-preview-footer {
				display: none;
			}
			.mui-zoom-scroller {
				position: absolute;
				display: -webkit-box;
				display: -webkit-flex;
				display: flex;
				-webkit-box-align: center;
				-webkit-align-items: center;
				align-items: center;
				-webkit-box-pack: center;
				-webkit-justify-content: center;
				justify-content: center;
				left: 0;
				right: 0;
				bottom: 0;
				top: 0;
				width: 100%;
				height: 100%;
				margin: 0;
				-webkit-backface-visibility: hidden;
			}
			.mui-zoom {
				-webkit-transform-style: preserve-3d;
				transform-style: preserve-3d;
			}
			.mui-slider .mui-slider-group .mui-slider-item img {
				width: auto;
				height: auto;
				max-width: 100%;
				max-height: 100%;
			}
			.mui-android-4-1 .mui-slider .mui-slider-group .mui-slider-item img {
				width: 100%;
			}
			.mui-android-4-1 .mui-slider.mui-preview-image .mui-slider-group .mui-slider-item {
				display: inline-table;
			}
			.mui-android-4-1 .mui-slider.mui-preview-image .mui-zoom-scroller img {
				display: table-cell;
				vertical-align: middle;
			}
			.mui-preview-loading {
				position: absolute;
				width: 100%;
				height: 100%;
				top: 0;
				left: 0;
				display: none;
			}
			.mui-preview-loading.mui-active {
				display: block;
			}
			.mui-preview-loading .mui-spinner-white {
				position: absolute;
				top: 50%;
				left: 50%;
				margin-left: -25px;
				margin-top: -25px;
				height: 50px;
				width: 50px;
			}
			.mui-preview-image img.mui-transitioning {
				-webkit-transition: -webkit-transform 0.5s ease, opacity 0.5s ease;
				transition: transform 0.5s ease, opacity 0.5s ease;
			}
			@-webkit-keyframes fadeIn {
				0% {
					opacity: 0;
				}
				100% {
					opacity: 1;
				}
			}
			@keyframes fadeIn {
				0% {
					opacity: 0;
				}
				100% {
					opacity: 1;
				}
			}
			@-webkit-keyframes fadeOut {
				0% {
					opacity: 1;
				}
				100% {
					opacity: 0;
				}
			}
			@keyframes fadeOut {
				0% {
					opacity: 1;
				}
				100% {
					opacity: 0;
				}
			}
			p img {
				max-width: 100%;
				height: auto;
			}
		</style>
	    <script type="text/javascript">
		var gentry=null,hl=null,le=null;
		var er=null,ep=null;
		var bUpdated=false; //用于兼容可能提前注入导致DOM未解析完更新的问题
		// H5 plus事件处理
		function plusReady(){
			// 获取音频目录对象
			plus.io.resolveLocalFileSystemURL('_doc/', function(entry){
				entry.getDirectory('audio', {create:true}, function(dir){
					gentry = dir;
					updateHistory();
				}, function(e){
					outSet('Get directory "audio" failed: '+e.message);
				});
			}, function(e){
				outSet('Resolve "_doc/" failed: '+e.message);
			} );
		}
		if(window.plus){
			plusReady();
		}else{
			document.addEventListener('plusready', plusReady, false);
		}
		// DOMContentLoaded事件处理
		document.addEventListener('DOMContentLoaded', function(){
			// 获取DOM元素对象
			hl = document.getElementById('history');
			le = document.getElementById('empty');
			er = document.getElementById('record');
			rt = document.getElementById('rtime');
			ep = document.getElementById('play');
			pt = document.getElementById('ptime');
			pp = document.getElementById('progress')
			ps = document.getElementById('schedule');
			updateHistory();
		},false);
		// 添加播放项
		function createItem( entry ) {
			var li = document.createElement('li');
			li.className = 'ditem';
			li.innerHTML = '<span class="iplay"><font class="aname"></font><br/><font class="ainf" id="ctime"></font></span>';
			li.setAttribute('onclick', 'playAudio1(this)');
			hl.insertBefore(li, le.nextSibling);
			li.querySelector('.aname').innerText = "播放音频文件";
			li.querySelector('.ainf').innerText = '...';
			li.entry = entry;
			updateInformation(li);
			// 设置空项不可见
			le.style.display = 'none';
		}
		// 开始录音
		var r=null,t=0,ri=null,rt=null;
		function startRecord(){}
		// 停止录音
		function stopRecord(){}
		// 清除历史记录
		function cleanHistory(){
			hl.innerHTML = '<li id="empty" class="ditem-empty">无历史记录</li>';
			le = document.getElementById('empty');
			// 删除音频文件
			outSet('清空录音历史记录：');
			gentry.removeRecursively(function(){
				// Success
				outLine('操作成功！');
			}, function(e){
				ouline('操作失败：'+e.message);
			});
		}
		// 获取录音历史列表
		function updateHistory(){
			if(bUpdated||!gentry||!document.body){//兼容可能提前注入导致DOM未解析完更新的问题
				return;
			}
		  	createItem();
			bUpdated = true;
		}
		// 获取录音文件信息
		function updateInformation(li){
			if(!li || !li.entry){
				return;
			}
			var entry = li.entry;
			entry.getMetadata(function(metadata){
				li.querySelector('.ainf').innerText = dateToStr(metadata.modificationTime);
			}, function(e){
				outLine('获取文件"'+entry.name+'"信息失败：'+e.message);
			} );
		}
		// 播放音频文件
		function playAudio(li){
			if(!li || !li.entry){
				ouSet('无效的音频文件');
				return;
			}
			outSet('播放音频文件：'+li.entry.name);
			startPlay('_doc/audio/'+li.entry.name);
		}
		// 播放文件相关对象
		var p=null,pt=null,pp=null,ps=null,pi=null;
		// 开始播放
		function startPlay(url){
			ep.style.display = 'block';
			var L = pp.clientWidth;
			p = plus.audio.createPlayer(url);
			p.play(function(){
				outLine('播放完成！');
				// 播放完成
				pt.innerText = timeToStr(d)+'/'+timeToStr(d);
				ps.style.webkitTransition = 'all 0.3s linear';
				ps.style.width = L+'px';
				stopPlay();
			}, function(e){
				outLine('播放音频文件"'+url+'"失败：'+e.message);
			});
			// 获取总时长
			var d = p.getDuration();
			if(!d){
				pt.innerText = '00:00:00/'+timeToStr(d);
			}
			pi = setInterval(function(){
				if(!d){ // 兼容无法及时获取总时长的情况
					d = p.getDuration();
				}
				var c = p.getPosition();
				if(!c){  // 兼容无法及时获取当前播放位置的情况
					return;
				}
				pt.innerText = timeToStr(c)+'/'+timeToStr(d);
				var pct = Math.round(L*c/d);
				if(pct < 8){
					pct = 8;
				}
				ps.style.width = pct+'px';
			}, 1000);
		}
		// 停止播放
		function stopPlay(){
			clearInterval(pi);
			pi=null;
			setTimeout(resetPlay, 500);
			// 操作播放对象
			if(p){
				p.stop();
				p=null;
			}
		}
		// 重置播放页面内容
		function resetPlay(){
			ep.style.display = 'none';
			ps.style.width = '8px';
			ps.style.webkitTransition = 'all 1s linear';
			pt.innerText = '00:00:00/00:00:00';	
		}
		// 重写关闭
		var _back=window.back;
		function resetback(){
			// 停止播放
			if(ep.style.display == 'block'){
				stopPlay();
			}else if(er.style.display == 'block'){
				stopRecord();
			}else{
				_back();
			}
		}
		window.back=resetback;
		
		function Audio2dataURL (path) {
		    plus.io.resolveLocalFileSystemURL(path, function(entry){
		        entry.file(function(file){
		            var reader = new plus.io.FileReader();
		            reader.onloadend = function (e) {
		                console.log(e.target.result);
		                document.getElementById("audiobox").value=e.target.result;
		            };
		            reader.readAsDataURL(file);
		        },function(e){
		            mui.toast("读写出现异常: " + e.message );
		        })
		    })
		}
		
		</script>
		<link rel="stylesheet" href="__PUBLIC__/appsource/css/common.css" type="text/css" charset="utf-8"/>
		<style type="text/css">
		.rp {
			width: 100%;
			height: 100%;
			display: none;
			text-align: center;
			position: fixed;
			top: 0;
			background: rgba(0,0,0,0.8);
			z-index: 9999;
			overflow: hidden;
		}
		.aname {
			font-size: 16px;
		}
		.ainf {
			font-size: 12px;
		}
		.rtime {
			font-size: 22px;
			color: #FF0000;
		}
		.ptime {
			margin-top: 40%;
			font-size: 22px;
			color: #FFFFFF;
		}
		.rprogress {
			background: url(../img/arecord.png) no-repeat center center;
			background-size: 32px 32px;
		}
		.rschedule {
		    background-color: rgba(0,0,0,0);
		    border: 5px solid rgba(0,183,229,0.9);
		    opacity: .9;
		    border-left: 5px solid rgba(0,0,0,0);
		    border-right: 5px solid rgba(0,0,0,0);
		    border-radius: 50px;
		    box-shadow: 0 0 15px #2187e7;
		    width: 36px;
		    height: 36px;
		    margin: 0 auto;
		    -webkit-animation: spin 1s infinite linear;
		    animation: spin 1s infinite linear;
		}
		@-webkit-keyframes spin {
		    0% {
		        -webkit-transform: rotate(0deg);
		    }
		    100% {
		        -webkit-transform: rotate(360deg);
		    }
		}
		@keyframes spin {
		    0% {
		        transform: rotate(0deg);
		    }
		    100% {
		        transform: rotate(360deg);
		    }
		}
		.progress {
		  width: 90%;
		  background-color: #666;
		  margin: 0 5%;
		  border: 1px solid #222;
		  -webkit-border-radius: 5px;
		  border-radius: 5px;
		}
		.schedule {
		  width: 8px;
		  height: 8px;
		  margin: 1px 0;
		  background-color: #FFCC33;
		  -webkit-border-radius: 4px;
		  border-radius: 4px;
		  -webkit-transition: all 1s linear;
		  transition: all 1s linear;
		}
		.stop {
			width: 72px;
			height: 72px;
			background: url(../../images/icons/astop.png) center center;
			background-size: 72px 72px;
			margin: auto;
			-webkit-border-radius: 72px;
			border-radius: 72px;
		}
		.stop:active{
		  	-webkit-box-shadow: 0 3px 8px rgba(0, 0, 0, 0.5) inset;
			box-shadow: 0 3px 8px rgba(0, 0, 0, 0.5) inset;
		}
		.iplay {
			display: block;
			background: no-repeat right center url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABYCAYAAAADWlKCAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAKwwAACsMBNCkkqwAAABZ0RVh0Q3JlYXRpb24gVGltZQAwOS8xMi8xM5w+I3MAAAAcdEVYdFNvZnR3YXJlAEFkb2JlIEZpcmV3b3JrcyBDUzVxteM2AAAD9UlEQVR4nO2b3XETMRRGDwzvoYOkg5hRAVkqiKmAdIA7wHSQVECoALsC1gXciV0BTge4gvCwgnHk9d/+WF8m97ztxrlXs8fS1Urym6enJxwd3uZugPMcFyKGCxHDhYjhQsRwIWK4EDFciBguRAwXIoYLEcOFiOFCxHAhYrgQMVyIGC5EDBcihgsRw4WI4ULEcCFiuBAx3uVuwDGY2XtgCBTAALjc8tEFMAdKYBJC+HOK9nXBm5dwUM7MCmAEXDcMMQVuQwhlV23qC2khZjYAboGrjkLOgFEIYd5RvM6RrSFmdgs80J0MYqyHGFsSuR4S60TJ9vrwCEziZ+YhhGXy/xdU9aWgqjfnW+IsgEKtvkgJiUPUPfUyZsD42DoQ68+Y+p62AG6UhjAZITt6xopq3L9vGf+Gqh6dJX+S6ilKNaRkU8YCGLSVARBjDGLMdS5jbgkkhMQiWyejSGtEG2KsghopKoU++5AV68ZDcrvXYWTH8Pghdz1R6CHpN3MFDPsc02PsYcy1qy0nJ6uQOANKZz+jfcOUmd3H6W1jYo5RcvsqtikbuXtI+kBmBxbwz8DczMZtksdcsz1tOinZhMRxPF2bGh8R4gz4amZLMxu2aEqa8zq2LQs5e0j6EB8bLv6dAz/NrGwyjMWcj3vadjJyCimS60nLeFfAbzO7bfANT3MXLdvSmJxCBsl12VHcL8AyvpkfSpo7bdvJyCkkfQfocv5/Bnw3s/mBs6Y097aFzd7JPcv6T5dv5GtcAr/2TZN7yt0IGSE908k0+RS8FiEvhhd1yKEFUw5YAVBApoe0XQrZwgL4GEIY7pLRU+5G5OwhC57PZgbAsqPYK6rdxUMXC9Npbro8fzJy9pB0qll0FPcOuDhCRl3ubEvwOYWUyXXb5YoZ1X7GqMHSfZq7bNmWxuQUki5XnDdc+n4EPoUQiiabSzFnejKl7TJOY7IJid/iaXJ7fESIFfCNas+9zQNMc05zHnjIPctKx/mrA9egflCJGLd5eDFXukGWdddQYU+95PlDWVE97GXPeS+oivf6saBZCKHoM+8+cvcQ2NyhOwMmfW4SxdgTNs9oZd0tBAEhsRDfJbcvgbIPKTtOnNzlPnECAkPWP8xsTv3ZrJ1v2UfmuKDqGRt5QgjZ9kDWyd5D1iioP1U4P3KzqZYYY5v0om38rpDpIeCHrUFMCPjPEeSE/COetf3SU/i7EEL2GVUdSjXkGfGBfWDzIFsb/q93dRizU2R7yDr+o09R/GfRzsmRrSGvFRcihgsRw4WI4ULEcCFiuBAxXIgYLkQMFyKGCxHDhYjhQsRwIWK4EDFciBguRAwXIoYLEcOFiOFCxHAhYrgQMf4CVuqCm+17t3sAAAAASUVORK5CYII=);
			background-size: 50px 44px;
			-ms-touch-action: auto;
		}
		</style>
 </head> 
 <body>
  <div class="mui-content"> 
  	
  		<ul class="mui-table-view" style="margin-top:0px">
			<li class="mui-table-view-cell">
				<a id="xuanzexiangmu">项目 <input name="xuanzexiangmu" readonly style="background-color:transparent;color:#777;margin-left:10px;border:0px;width:80%;"></a>
			</li>
		</ul>
		<ul class="mui-table-view" style="border-top:1px solid #eee">
			<li class="mui-table-view-cell">
				<a id="xuanzegongxu">节点 <input name="xuanzegongxu" readonly style="background-color:transparent;color:#777;margin-left:10px;border:0px;width:80%"></a>
			</li>
		</ul>
		<ul class="mui-table-view" style="border-top:1px solid #eee">
			<li class="mui-table-view-cell">
				<a id="xuanzegongxu">应当完成量 <input name="yingdangwanchengliang" readonly style="background-color:transparent;color:#777;margin-left:10px;border:0px;width:50%"></a>
			</li>
		</ul>
		<ul class="mui-table-view" style="border-top:1px solid #eee">
			<li class="mui-table-view-cell">
				<a id="xuanzegongxu">实际完成量 <input name="wanchengchengdu" readonly style="background-color:transparent;color:#777;margin-left:10px;border:0px;width:50%"></a>
			</li>
		</ul>
		<ul class="mui-table-view" style="border-top:1px solid #eee">
			<li class="mui-table-view-cell">
				<a id="xuanzegongxu">人员 <input name="renyuan" readonly style="background-color:transparent;color:#777;margin-left:10px;border:0px;width:80%"></a>
			</li>
		</ul>
		<ul class="mui-table-view" style="border-top:1px solid #eee">
			<li class="mui-table-view-cell">
				<a id="xuanzegongxu">时间 <input name="shijian" readonly style="background-color:transparent;color:#777;margin-left:10px;border:0px;width:80%"></a>
			</li>
		</ul>
		<div style="height:6px"></div>
		<ul class="mui-table-view">
			<li class="mui-table-view-cell">
				<a id="mudigang">填写日志</a>
				<textarea name="rizhi" id="rizhi" style="background-color:#f7f7f7;color:#777;border:0px;position:relative;top:10px;height:120px"></textarea>
			</li>
		</ul>
		<div style="height:6px"></div>
		<ul class="mui-table-view" id="imagebox" style="display:none">
			<li class="mui-table-view-cell">
				<a id="huowuleixing">拍照上传 </a> 
				<div class="showimg" id="images" style="float:left">
					
  				</div> 
				
			</li>
		</ul>
		<div style="height:6px"></div>
		<ul class="mui-table-view" id="voicebox" style="padding-bottom:1px;display:none">
			
				<a id="huowuleixing" style="position:relative;top:5px;left:15px">语音说明 </a>
				
				<ul id="history" class="dlist" style="text-align:left;">
					<li id="empty" class="ditem-empty">无历史记录</li>
				</ul>
				
				
				<div id="output" style="display:none">
					Audio用于管理音频设备，可调用麦克风录制音频文件，也可播放音频文件。
				</div>
							
				<div id="play" class="rp">
					<div id="ptime" class="ptime">00:00:00/00:00:00</div><br/>
					<div id="progress" class="progress"><div id="schedule" class="schedule"></div></div>
					<br/>
					<div class="stop" onclick="stopPlay(),outSet('停止播放！')"></div>
				</div>
				<div id="record" class="rp">
					<div style="width:100%;height:20%;"></div>
					<div class="rprogress"><div class="rschedule"></div></div>
					<br/>
					<div id="rtime" class="rtime">00:00:00</div><br/>
					<div class="stop" onclick="stopRecord()"></div>
				</div>
		</ul>
  </div> 
  <div id='userResult' style="display:none"></div>
  <input id='plmid' style="display:none">
  <input id='worktypeid' style="display:none">
  <input id='imagebox' style="display:none">
  <input id='audiobox' style="display:none">
  <script src="__PUBLIC__/appsource/js/mui.min.js"></script> 
  <script src="__PUBLIC__/appsource/js/mui.zoom.js"></script>
  <script src="__PUBLIC__/appsource/js/mui.previewimage.js"></script>
  <script src="__PUBLIC__/appsource/js/jquery.js"></script>
  <script src="__PUBLIC__/appsource/js/mui.picker.js"></script>
  <script src="__PUBLIC__/appsource/js/mui.poppicker.js"></script>
  <script src="__PUBLIC__/appsource/js/jquery-3.2.1.min.js"></script>
  
  <script src="__PUBLIC__/appsource/js/voice-2.0.js"></script>
  
  <script src="__PUBLIC__/appsource/js/mui.zoom.js"></script>
  <script src="__PUBLIC__/appsource/js/mui.previewimage.js"></script>
  <script></script>
  <script type="text/javascript">
        mui.init();
        var account = "{$account}";
        var voice="";
		var id = "{$id}"
        $(function() {
        	//获取项目列表
        	mui.ajax("http://projectnandian.jiuze9.com/projecttest/Rbac/index.php/App/dailydetail/id/"+id+"/account/"+account,{
					dataType:'json',//服务器返回json格式数据
					type:'post',//HTTP请求类型					
					headers:{'Content-Type':'application/json'},	              
					success:function(data){
						var result = new Array();  
						result = eval(data);
						document.getElementsByName("xuanzexiangmu")[0].value=result["plm"];
						document.getElementsByName("xuanzegongxu")[0].value=result["worktype"];
						document.getElementsByName("rizhi")[0].value=result["content"];
						document.getElementsByName("yingdangwanchengliang")[0].value=result["planpercent"];
						document.getElementsByName("wanchengchengdu")[0].value=result["percent"];
						document.getElementsByName("renyuan")[0].value=result["user"];
						document.getElementsByName("shijian")[0].value=result["ctime"];
					
						if(typeof result["photo"] != "undefined" && result["photo"] != null && result["photo"] != "")
						{
							
							document.getElementById("imagebox").style.display="block";
							var photos=result["photo"].split(",");
							for(x in photos)   
							{ 
								if(typeof photos[x] != "undefined" && photos[x] != null && photos[x] != "")
								{
									$('#images').prepend('<div class="add-tp" id="dd' + picIndex + '">' +
									'<img data-preview-src="" data-preview-group="1" src="http://projectnandian.jiuze9.com/projecttest/Public/Uploads/' + photos[x] + '">' +
									'</div>');
								}
							}
							
							mui.previewImage();
							//data-preview-src="" data-preview-group="1"
						}
						if(typeof result["voicedata"] != "undefined" && result["voicedata"] != null && result["voicedata"] != "")
						{
							document.getElementById("voicebox").style.display="block";
							voice=result["voicedata"];
							document.getElementById("ctime").innerText=result["date"];
						}
						
					},
				});
        	
        })
        RongIMLib.RongIMVoice.init();
        function playAudio1()
        {
        	console.log(voice);
        	RongIMLib.RongIMVoice.play(voice);
        }
		var picIndex=0;
        function change() {
			if (mui.os.plus) {
				var a = [{
					title: "拍照"
				}, {
					title: "相册选取"
				}];
				plus.nativeUI.actionSheet({
					cancel: "取消",
					buttons: a
				}, function(b) {
					switch (b.index) {
						case 0:
							break;
						case 1:
							getImage(); //调用摄像头
							break;
						case 2:
							galleryImg();
							break;
						default:
							break
					}
				})
			}
		}
        
        
        function getImage() {
			var cmr = plus.camera.getCamera();
			cmr.captureImage(function(p) {
					plus.io.resolveLocalFileSystemURL(p, function(entry) {
							var path = entry.toLocalURL();
							$('#images').prepend('<div class="add-tp" id="dd' + picIndex + '">' +
								'<img src="' + path + '">' +
								'<div><img id="d' + picIndex + '" onclick=DelPic("d' + picIndex + '") src="../images/close.png" /></div>' +
								'</div>');
							picIndex += 1;
							appendFile(path); //处理图片的地方
							setTimeout("upload(1)", 1000);
						},
						function(e) {
							alert("读取拍照文件错误：" + e.message);
						});
				},
				function(e) {
					//alert("失败：" + e.message);
				}, {
					filename: "_doc/camera/",
					index: 1
				});
		}
        
        
        function galleryImg() {
			plus.gallery.pick(function(path) {
				$('#images').prepend('<div class="add-tp"  id="dd' + picIndex + '">' +
					'<img src="' + path + '" >' +
					'<div style="display:none"><img id="d' + picIndex + '" onclick=DelPic("d' + picIndex + '") src="../../images/icons/6.png" /></div>' +
					'</div>');
				picIndex += 1;
				appendFile(path); //处理图片的地方
				//setTimeout("upload(2)", 1000);
			}, function(e) {
				console.log("取消选择图片");
			}, {
				filter: "none",
				system: false
			});
		}
        
        function appendFile(path) {
			var img = new Image();
			img.src = path; // 传过来的图片路径在这里用。
			img.onload = function() {
				var that = this;
				//生成比例 
				var w = that.width,
					h = that.height,
					scale = w / h;
				w = 480 || w; //480  你想压缩到多大，改这里
				h = w / scale;
				//生成canvas
				var canvas = document.createElement('canvas');
				var ctx = canvas.getContext('2d');
				$(canvas).attr({
					width: w,
					height: h
				});
				ctx.drawImage(that, 0, 0, w, h);
				var base64 = canvas.toDataURL('image/jpeg', 1 || 1); //1最清晰，越低越模糊。
				f1 = base64;
				document.getElementById("imagebox").value=f1;
			}
		}
        
        function upload(index) {
			var url = 'http://www./Service/ConsultationManager.ashx?action=getImage';
			var dataType = 'json';
			//发送数据  
			var data = {
				files1: f1, //base64数据
				index: index
			};
			$.post(url, data, success, dataType);
			console.log('photo finish');
		}
    </script> 
    <script type="text/javascript" src="__PUBLIC__/appsource/js/immersed.js" ></script>
    
 </body>
</html>