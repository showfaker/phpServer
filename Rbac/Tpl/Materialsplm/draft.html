	<link rel="shortcut icon" href="favicon.ico"> <link href="css/bootstrap.min.css?v=3.3.6" rel="stylesheet">
    <link href="css/font-awesome.css?v=4.4.0" rel="stylesheet">

    <!-- Data Tables -->
    <link href="css/plugins/dataTables/dataTables.bootstrap.css" rel="stylesheet">
    <link href="css/plugins/chosen/chosen.css" rel="stylesheet">
    <link href="css/animate.css" rel="stylesheet">
    <link href="css/style.css?v=4.1.0" rel="stylesheet">
	<link rel="stylesheet" href="css/main.css">
	


	<form id="format1" method="post" action="__URL__/insert" enctype="multipart/form-data" class="form-horizontal">    
		<div class="modal-body" style="padding:0px;margin:0px">
			<div class="form-group">
				<div class="col-sm-12" style="margin-bottom: 20px;">
					<label class="col-sm-2 control-label">选择项目：</label>
					<div class="col-sm-4">
					    <select name="plmid" data-placeholder="请选择项目" class="chosen-select" style="width:230px;" tabindex="2">
							<option value="">请选择项目</option>
							<volist name="projects" id="project">
							<option value="{$project.id}" hassubinfo="true">{$project.title}</option>
							</volist>
						</select>
					</div>
				</div>
			</div>
			<div class="">
				<a onclick="fnClickAddRow();" href="javascript:void(0);" class="btn btn-primary ">添加行</a>
			</div>
			<div style="height:300px;overflow-y:auto;overflow-x:hidden;">
			<table class="table table-striped table-bordered table-hover " id="editable">
				<thead>
					<tr>
						<th width="8%">材料名称</th>
						<th width="6%">材料类别</th>
						<th width="5%">规格型号</th>
						<th width="5%">单位</th>
						<th width="5%">价格</th>
						<th width="6%">密度</th>
						<th width="5%">操作</th>
					</tr>
				</thead>
				<tbody>
					
					<tr id="table-row-0">
						<td>
						<input type="text" placeholder="材料名称" class="form-control" size="20%" name="para1[]" id="para1_0">
						<a href="" onclick="find1(this)" title="0" data-toggle="modal" data-target="#modal" data-backdrop="static"  target="dialog" class="btn btn-info btn-xs">查找</a>
						</td>
						<td>
							<select name="para2[]" id="para2_0" class="form-control" style="width:130px;">
								<option value="">请选择类别</option>
								<volist name="leibie" id="llist">
									<option value="{$llist.name}">{$llist.name}</option>
								</volist>
							</select>
						</td>
						<td><input type="text" placeholder="规格型号" class="form-control" size="6%" name="para3[]" id="para3_0"></td>
						<td><input type="text" placeholder="单位" class="form-control" size="5%" name="para4[]" id="para4_0" required="required"></td>
						<td><input type="text" placeholder="价格" onkeyup="calcprice()" class="form-control price" size="5%" name="para5[]" value="0" id="para5_0"></td>
						<td><input type="text" placeholder="密度" class="form-control" size="5%" name="para7[]" value="0" id="para7_0"></td>
						<td>						
						<a class="btn btn-danger btn-xs delete" href="javascript:void(0);">删除</a>
						</td>				
					</tr>
				</tbody>
			</table>
			</div>
		</div>	
		<input type="hidden" name="orderid" value="{$check_orderid}">
		<input type="hidden" name="tj_id" value="{$check_tj_id}">
		<div class="modal-footer">
			<button type="button" onclick="changeout(this)" class="btn btn-primary" id="myconfirm">确认提交</button>
			<a id="btnclick" href="" data-toggle="modal" data-target="#modal" data-backdrop="static"  target="dialog"  class="btn btn-primary hidden"></a>
		</div>
	</form>
    <script src="js/jquery.min.js?v=2.1.4"></script>	
    <!-- Chosen -->
    <script src="js/plugins/chosen/chosen.jquery.js"></script>
    <script src="js/demo/form-advanced-demo.js"></script>
	<!-- jQuery Validation plugin javascript-->
    <script src="js/plugins/validate/jquery.validate.min.js"></script>
    <script src="js/plugins/validate/messages_zh.min.js"></script>

    <script src="js/demo/form-validate-demo.js"></script>
	<script>
		var table=$('#editable').dataTable(
		{
		   iDisplayLength : 10000
		}
		);
    </script>
    <script>
		var currentrow=1;
        function fnClickAddRow() {
            $('#editable').dataTable().fnAddData([
				'<input type="text" placeholder="材料名称" class="form-control" size="20%" name="para1[]" id="para1_'+currentrow+'"><a href="" onclick="find1(this)" title="'+currentrow+'" data-toggle="modal" data-target="#modal" data-backdrop="static"  target="dialog" class="btn btn-info btn-xs">查找</a>',
                '<select name="para2[]" id="para2_'+currentrow+'" data-placeholder="请选择类别" class="form-control" style="width:130px;"><option value="">请选择类别</option><volist name="leibie" id="llist"><option value="{$llist.name}">{$llist.name}</option></volist></select>',
                '<input type="text" placeholder="规格型号" class="form-control" size="6%" name="para3[]" id="para3_'+currentrow+'">',
                '<input type="text" placeholder="单位" class="form-control" size="5%" name="para4[]" id="para4_'+currentrow+'">',
                '<input type="text" placeholder="价格" onkeyup="calcprice()" class="form-control price" size="5%" name="para5[]" value="0" id="para5_'+currentrow+'">',
				'<input type="text" placeholder="密度" class="form-control" size="5%" name="para7[]" value="0" id="para7_'+currentrow+'">',
				'<a class="btn btn-danger btn-xs delete" href="javascript:void(0);">删除</a>'
				]);
			currentrow++;
			$('.delete').on('click', function(e) {
				var table = $('#editable').DataTable();
				table.row($(this).parents('tr')).remove().draw();
			});
        }
		function calcprice()
		{
			var sum=0;
			$(".count").each(function(){
				var t=$(this).val();
				var n=$(this).parent().parent().find(".price").val();
				var a=t*n;
				sum+=Number(a);
			})
			sum=sum.toFixed(2);
			document.getElementById("price").value=sum;
		}
		
    </script>
	<script>
	function changeout(test){
		// $('#myconfirm').attr('disabled',true);
		var city=$("select[name='city']").val();
		var plmid=$("select[name='plmid']").val();
		var groupid=$("select[name='groupid']").val();
		var orderid=$("input[name='orderid']").val();
		var tj_id=$("input[name='tj_id']").val();
		var date=$("input[name='date']").val();
		var step=$("select[name='step']").val();
		var mid=new Array();
		var brand_null=0;
		var unit_null =0;
		var number_null=0;
		
		var name=new Array();
		$("input[name='para1[]']").each(function(i,value){
			name[i]=$(this).val();
		});
		var brand=new Array();
		$("select[name='para2[]']").each(function(i,value){
			brand[i]=$(this).val();
		});
        var standard=new Array();
		$("input[name='para3[]']").each(function(i,value){
			standard[i]=$(this).val();
		 });
        var unit=new Array();
		$("input[name='para4[]']").each(function(i,value){
			unit[i]=$(this).val();
		});
		var price=new Array();
		$("input[name='para5[]']").each(function(i,value){		
			price[i]=$(this).val();
		});
        var count=new Array(); 
		$("input[name='para6[]']").each(function(i,value){
			count[i]=$(this).val();
		});
		
		var count1=new Array(); 
		$("input[name='para8[]']").each(function(i,value){
			count1[i]=$(this).val();
		});
		var count2=new Array(); 
		$("input[name='para9[]']").each(function(i,value){
			count2[i]=$(this).val();
		});
		
		
		var density=new Array(); 
		$("input[name='para7[]']").each(function(i,value){
			density[i]=$(this).val();
		});
		var found=$("input[name='price']").val();

		for(var i=0;i<brand.length;i++){
			if(brand[i]==''){
				alert('请选择材料类别');
				brand_null=1;
			}
			if(brand[i]==null){
				alert('请选择材料类别');
				brand_null=1;
			}
		}


		for(var i=0;i<unit.length;i++){
			if(unit[i]==''){
				alert('请填写单位.');
				unit_null=1;
			}
			if(unit[i]==null){
				alert('请填写单位.');
				unit_null=1;
			}
		}
		if(plmid==''){
			alert('请选择项目');
			return;
		}
		//alert(plmid);alert(name);alert(brand);alert(standard);alert(unit);alert(price);
		if(brand_null==0 && unit_null==0){
			var aj = $.ajax({
				url:'__URL__/ajaxinsert',
				data:{
					plmid:plmid,name:name,brand:brand,standard:standard,unit:unit,price:price,count:count,count1:count1,count2:count2,found:found,orderid:orderid,density:density,groupid:groupid,date:date,step:step
				},
				type:'post',  
				cache:false,
				dataType:'json',  
				success:function(data) {
					console.log(data);
					if(data==0){
						$('#myconfirm').attr('disabled',false);
						alert('没有找到对应的供应商,请先新建供应商再下单.');
					}else{
						if(data!=null){
							location.href=location.href;
						}
					}
				}  
			}); 
		}else{
			$('#myconfirm').attr('disabled',false);
		}
			
	}
	
	</script>


    <script>
        function find(e){
        var city=$("select[name='city']").val();
        // alert(supplier);
        var number=$(e).prev().val();
        if($('input[name="tj_id"]').val()>0){
        	var supplier=$("input[id='para6_0']").val();
        	$(e).attr("href","__URL__/choice/key/"+e.title+"/city/"+city+"/supplier/"+supplier+"/number/"+number);
        }else{
        	$(e).attr("href","__URL__/choice/key/"+e.title+"/city/"+city+"/number/"+number);
        }		
		 
		}
    	
	</script>
	<script>
        function find1(e){
        var city=$("select[name='city']").val();
        // var supplier=$("input[id='para6_0']").val();
        var name=$(e).prev().val();	
        // alert(name);	
		 if($('input[name="tj_id"]').val()>0){
        	var supplier=$("input[id='para6_0']").val();
        	$(e).attr("href","__URL__/choice/key/"+e.title+"/city/"+city+"/supplier/"+supplier+"/name/"+name);
        }else{
        	$(e).attr("href","__URL__/choice/key/"+e.title+"/city/"+city+"/name/"+name);
        }	 
		}
    	
	</script>