	<link rel="shortcut icon" href="favicon.ico"> <link href="css/bootstrap.min.css?v=3.3.6" rel="stylesheet">
    <link href="css/font-awesome.css?v=4.4.0" rel="stylesheet">

    <!-- Data Tables -->
    <link href="css/plugins/dataTables/dataTables.bootstrap.css" rel="stylesheet">
    <link href="css/plugins/chosen/chosen.css" rel="stylesheet">
    <link href="css/animate.css" rel="stylesheet">
    <link href="css/style.css?v=4.1.0" rel="stylesheet">
	<link rel="stylesheet" href="css/main.css">
	


	<form id="format1" method="post" action="" enctype="multipart/form-data" class="form-horizontal">  
        <input type="hidden" name="id" value="{$id}">
        <input type="hidden" name="isedit" value="{$isedit}">
        <input type="hidden" name="tj_id" value="{$tj_id}">
        <input type="hidden" name="count" value="{$materialcount}">	
		<div class="modal-body">
			<div class="form-group">
				<div class="col-sm-12">
					<div class="input-group col-sm-6 col-xs-6" style="float:left;padding-right:20px">
					<span class="input-group-addon">项目名称</span>
					<input type="" name="title" value="{$orderinfo.title}" class="form-control"  style="display:inline;">
					</div>
					
					<div class="input-group col-sm-6 col-xs-6" style="float:left;padding-right:20px">
					<span class="input-group-addon">充换电设施用途</span>
					<input type="" name="purpose" value="{$orderinfo.purpose}" class="form-control"  style="display:inline;">
					</div>
				</div>
				<div class="col-sm-12" style="margin-top:10px">
					<div class="input-group col-sm-6 col-xs-6" style="float:left;padding-right:20px">
					<span class="input-group-addon">发货地址</span>
					<input type="" name="address" value="{$orderinfo.address}" class="form-control"  style="display:inline;">
					</div>
					<div class="input-group col-sm-6 col-xs-6" style="float:left;padding-right:20px">
					<span class="input-group-addon">其他</span>
					<input type="" name="remark" value="{$orderinfo.remark}" class="form-control"  style="display:inline;">
					</div>
				</div>
			</div>
			<div class="">
				<a onclick="fnClickAddRow();" href="javascript:void(0);" class="btn btn-primary ">添加行</a>
			</div>
			<div style="height:300px;overflow-y:auto;overflow-x:hidden;">
			<table class="table table-striped table-bordered table-hover " id="editable">
				<thead>
					<tr>
						<th width="15%">商品名称</th>
						<th width="6%">商品类别</th>
						<th width="5%">规格</th>
						<th width="5%">单位</th>
						<th width="10%">供应商</th>
						<th width="5%">单价</th>
						<th width="5%">数量</th>
						<th width="5%">操作</th>
					</tr>
				</thead>
				<tbody>
					<volist name="materials" id="materials">
					<tr id="table-row-0">
						<td>
						<input type="hidden" name="mid[]" id="mid_{$key}">
						<input type="hidden" name="para1[]" value="{$materials.number}" id="para1_{$key}">
						<input type="text" placeholder="商品名称" class="form-control" size="10%" name="para2[]" value="{$materials.name}" id="para2_{$key}" readonly>
						<a href="" onclick="find1(this)" title="{$key}" data-toggle="modal" data-target="#modal" data-backdrop="static"  target="dialog" class="btn btn-info btn-xs">查找</a>
						</td>
						<td><input type="text" placeholder="类别" class="form-control" size="6%" name="para3[]" value="{$materials.brand}" id="para3_{$key}" readonly></td>
						<td><input type="text" placeholder="规格" class="form-control" size="6%" name="para4[]" value="{$materials.standard}" id="para4_{$key}" readonly></td>
						<td><input type="text" placeholder="单位" class="form-control" size="5%" name="para5[]" value="{$materials.unit}" id="para5_{$key}" readonly></td>
						<eq name="pay" value="">
						<td><input type="text" placeholder="供应商" class="form-control" size="10%" name="para6[]" value="{$materials.supplier}" id="para6_{$key}" title="supplier" readonly></td>
						</eq>
						<neq name="pay" value="">
						<td><input type="text" placeholder="供应商" class="form-control" size="10%" name="para6[]" value="{$materials.supplier}" id="para6_{$key}" readonly="true" title="supplier"></td>
						</neq>
						<td><input type="text" placeholder="单价" oninput="calcprice()" class="form-control price" size="5%" name="para7[]" value="{$materials.price}" id="para7_{$key}" readonly></td>
						<td><input type="text" placeholder="数量" oninput="calcprice()" class="form-control count" size="5%" name="para10[]" value="{$materials.count}" id="para10_{$key}"></td>                        
						<td>						
						<a class="btn btn-danger btn-xs delete" href="javascript:void(0);">删除</a>
						</td>				
					</tr>
					</volist>
				</tbody>
			</table>
			</div>
		</div>	
		<div class="modal-footer">
		
			<span style="float:left">商品总价：</span><input type="text" readonly placeholder="总价自动计算" class="form-control" style="width:150px;float:left;position:relative;top:-7px" name="price" id="price">
			<a href="#" onclick="changeout(this)" class="btn btn-primary">确认订单</a>
			<a id="btnclick" href="" data-toggle="modal" data-target="#modal" data-backdrop="static"  target="dialog"  class="btn btn-primary hidden"></a>
			
		</div>
	</form>
    <script src="js/jquery.min.js?v=2.1.4"></script>	
    <!-- Chosen -->
    <script src="js/plugins/chosen/chosen.jquery.js"></script>
	<!--
    <script src="js/demo/form-advanced-demo.js"></script>
	-->
    <script>
		var sum=0;
			$(".count").each(function(){
				var t=$(this).val();
				var n=$(this).parent().parent().find(".price").val();
				var a=t*n;
				sum+=Number(a);
			})
			sum=sum.toFixed(2);
			document.getElementById("price").value=sum;
    </script>
    <script>
    var currentrow=$('input[name="count"]').val();
        function fnClickAddRow() {
            $('#editable').dataTable().fnAddData([
				'<input type="hidden" name="mid[]" id="mid_'+currentrow+'"><input type="hidden" name="para1[]" id="para1_'+currentrow+'"><input type="text" placeholder="商品名称" class="form-control" size="10%" name="para2[]" id="para2_'+currentrow+'" readonly><a href="" onclick="find1(this)" title="'+currentrow+'" data-toggle="modal" data-target="#modal" data-backdrop="static"  target="dialog" class="btn btn-info btn-xs">查找</a>',
                '<input type="text" placeholder="类别" class="form-control" size="6%" name="para3[]" id="para3_'+currentrow+'" readonly>',
                '<input type="text" placeholder="规格" class="form-control" size="6%" name="para4[]" id="para4_'+currentrow+'" readonly>',
                '<input type="text" placeholder="单位" class="form-control" size="5%" name="para5[]" id="para5_'+currentrow+'" readonly>',
                '<eq name="pay" value=""><td><input type="text" placeholder="供应商" title="supplier" class="form-control" size="10%" name="para6[]" value="" id="para6_'+currentrow+'" readonly></td></eq><neq name="pay" value=""><td><input type="text" placeholder="供应商" class="form-control" title="supplier" size="10%" name="para6[]" value="{$supplier}" id="para6_'+currentrow+'" readonly="true"></td></neq>',
                '<input type="text" placeholder="单价" oninput="calcprice()" class="form-control price" size="5%" name="para7[]" value="0" id="para7_'+currentrow+'" readonly>',
				'<input type="text" placeholder="数量" oninput="calcprice()" class="form-control count" size="5%" name="para10[]" value="0" id="para10_'+currentrow+'">',
				'<a class="btn btn-danger btn-xs delete" href="javascript:void(0);">删除</a>'
				]);
			currentrow++;
			$('.delete').on('click', function(e) {
				var table = $('#editable').DataTable();
				table.row($(this).parents('tr')).remove().draw();
				calcprice();
			});
        }
		$('.delete').on('click', function(e) {
			var table = $('#editable').DataTable();
			table.row($(this).parents('tr')).remove().draw();
			calcprice();
		});
		function calcprice()
		{
			var sum=0;
			$(".count").each(function(){
				var t=$(this).val();
				var n=$(this).parent().parent().find(".price").val();
				var a=t*n;
				sum+=Number(a);
			})
			sum=sum.toFixed(2);
			document.getElementById("price").value=sum;
		}
		
    </script>
     

	<!--<script>
	    $("#sub").click(function(){
           $("#format1").submit();
		})
	</script>-->
    
	<script>
	function changeout(test){
		var title=$("input[name='title']").val();
		var address=$("input[name='address']").val();
		var purpose=$("input[name='purpose']").val();
		var remark=$("input[name='remark']").val();
		
		var city=$("select[name='city']").val();
		var plmid=$("select[name='plmid']").val();
		var orderid=$("input[name='id']").val();
		var tj_id=$("input[name='tj_id']").val();
		var isedit=$("input[name='isedit']").val();
		var mid=new Array();
		$("input[name='mid[]']").each(function(i,value){		
			mid[i]=$(this).val();
		  });
		var number=new Array();
		$("input[name='para1[]']").each(function(i,value){		
			number[i]=$(this).val();
		  });
		var name=new Array();
		$("input[name='para2[]']").each(function(i,value){
			name[i]=$(this).val();
		  });
		var brand=new Array();
		$("select[name='para3[]']").each(function(i,value){
			brand[i]=$(this).val();
		  });
        var standard=new Array();
		$("input[name='para4[]']").each(function(i,value){
			standard[i]=$(this).val();
		  });
        var unit=new Array();
		$("input[name='para5[]']").each(function(i,value){
			unit[i]=$(this).val();
		  });
        var supplier=new Array(); 
		$("input[name='para6[]']").each(function(i,value){
			supplier[i]=$(this).val();
		  });
        var price=new Array();
		$("input[name='para7[]']").each(function(i,value){
			price[i]=$(this).val();
		  });
		var threeprice=new Array();
		$("input[name='para8[]']").each(function(i,value){
			threeprice[i]=$(this).val();
		  });
        var lowprice=new Array();
		$("input[name='para9[]']").each(function(i,value){
			lowprice[i]=$(this).val();
		  });		  
        var count=new Array();
        var flag=1;
		$("input[name='para10[]']").each(function(i,value){
			count[i]=$(this).val();
			if($(this).val()==0){
				alert('数量不能为0.');
				flag=0;
			}
		  });
		 //  $("select[name='para3[]']").each(function(i,value){
			// if($(this).val()==''){
			// 	alert('类别不能为空.');
			// 	flag=0;
			// }
		 //  });
		 for(var i=0;i<brand.length;i++){
			// alert(brand[i]);
			if(brand[i]==''){
				alert('请选择商品类别.');
				flag=0;
			}
			if(brand[i]==null){
				alert('请选择商品类别.');
				flag=0;
			}
		}		
		var found=$("input[name='price']").val();
		if(flag==1){
			var aj = $.ajax({
						url:'__URL__/ajaxupdate',
						data:{  
							title:title,purpose:purpose,address:address,remark:remark,mid:mid,city:city,plmid:plmid,number:number,name:name,brand:brand,standard:standard,unit:unit,supplier:supplier,price:price,threeprice:threeprice,lowprice:lowprice,count:count,found:found,orderid:orderid,tj_id:tj_id
						},
						type:'post',  
						cache:false,  
						dataType:'json',  
						success:function(data) {
							if(data==0){
								$('#myconfirm').attr('disabled',false);
								alert('没有找到对应的供应商,请先新建供应商再下单.');
							}else if(data==1){
								$('#myconfirm').attr('disabled',false);
								alert('请填写单位.');
							}else if(data==2){
								$('#myconfirm').attr('disabled',false);
								alert('每个单据只能选择一个供应商的商品.');
							}else{
								if(data!=null){
									$("#btnclick").attr("href","__URL__/confirm/id/"+data+"/tj_id/"+tj_id+"/isedit/"+isedit);
									$("#btnclick").click();
								}
							}
						}  
					}); 
		}
			
	}
	
	</script>
   
	<script>
	    $("select[name='city']").change(function(){
		$("#opt").nextAll().remove();
		var city=$(this).val();
		var aj = $.ajax({
				url:'__URL__/ajaxcity',
				data:{  
					city : city
				},
				type:'post',  
				cache:false,  
				dataType:'json',  
				success:function(data) {
					if(data!=null){
						var code="";
						for(var i=0;i<data.length;i++){
						code+="<option value='"+data[i]['id']+"'>"+data[i]['title']+"</option>";
						}
						$("select[name='plmid']").append(code);
					}					
					
				}  
			});
		
		})
	
	</script>

    <script>
        function find(e){
        var city=$("select[name='city']").val();
        // alert(supplier);
        var number=$(e).prev().val();
        if($('input[name="tj_id"]').val()>0){
        	var supplier=$("input[id='para6_0']").val();
        	$(e).attr("href","__URL__/choice/key/"+e.title+"/city/"+city+"/supplier/"+supplier+"/number/"+number);
        }else{
        	$(e).attr("href","__URL__/choice/key/"+e.title+"/city/"+city+"/number/"+number);
        }		
		 
		}
    	
	</script>
	<script>
        function find1(e){
        var city=$("select[name='city']").val();
        // var supplier=$("input[id='para6_0']").val();
        var name=$(e).prev().val();	
        // alert(name);	
		 if($('input[name="tj_id"]').val()>0){
        	var supplier=$("input[id='para6_0']").val();
        	$(e).attr("href","__URL__/choice/key/"+e.title+"/city/"+city+"/supplier/"+supplier+"/name/"+name);
        }else{
        	$(e).attr("href","__URL__/choice/key/"+e.title+"/city/"+city+"/name/"+name);
        }	 
		}
    	
	</script>